<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>asu</title>
        <link href="css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="js/jquery-1.10.2.min.js" defer></script>
        <script src="js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href=".">asu</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="active">
                                <a href=".">Attendedsysupgrade Server for OpenWrt (GSoC 2017)</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="reference/common/">Common</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="disabled">
                                <a rel="next" >
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="reference/common/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#attendedsysupgrade-server-for-openwrt-gsoc-2017">Attendedsysupgrade Server for OpenWrt (GSoC 2017)</a></li>
            <li><a href="#clients">Clients</a></li>
            <li><a href="#server">Server</a></li>
            <li><a href="#run-your-own-server">Run your own server</a></li>
            <li><a href="#api">API</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="attendedsysupgrade-server-for-openwrt-gsoc-2017">Attendedsysupgrade Server for OpenWrt (GSoC 2017)<a class="headerlink" href="#attendedsysupgrade-server-for-openwrt-gsoc-2017" title="Permanent link">&para;</a></h1>
<p>This project intends to simplify the sysupgrade process of devices running
OpenWrt or distributions based on the former like LibreMesh. The provided tools
here offer an easy way to reflash the router with a new version or package
upgrades, without the need of <code>opkg</code> installed.</p>
<p>Additionally it offers an API (covered below) to request custom images with any
selection of packages pre-installed, allowing to create firmware images without
the need of setting up a build environment, even from mobile devices.</p>
<h2 id="clients">Clients<a class="headerlink" href="#clients" title="Permanent link">&para;</a></h2>
<h3 id="yet-another-firmware-selector">Yet another firmware selector<a class="headerlink" href="#yet-another-firmware-selector" title="Permanent link">&para;</a></h3>
<p>Simple web interface using vanilla JavaScript currently developed by @mwarning.
It offers a device search based on model names and show links either to
<a href="https://downloads.openwrt.org/">official images</a> or requests images via the
<em>asu</em> API. Please join in the development at the <a href="https://github.com/mwarning/yet_another_firmware_selector">GitHub
repository</a></p>
<p><img alt="yafs" src="misc/yafs.png" /></p>
<h3 id="luci-app">LuCI app<a class="headerlink" href="#luci-app" title="Permanent link">&para;</a></h3>
<p>The package <code>luci-app-attendedsysupgrade</code> <a href="https://github.com/openwrt/luci/tree/master/applications/luci-app-attendedsysupgrade">still
exists</a>
but is currently not usable with the rewritten server implementation. The app
will however be upgraded as soon as possible to be usable again.</p>
<h2 id="server">Server<a class="headerlink" href="#server" title="Permanent link">&para;</a></h2>
<p>The server listens to image requests and automatically generate them if the
request was valid. This is done by automatically setting up OpenWrt
ImageBuilders and cache images in a Redis database. This allows to quickly
respond to requests without rebuilding existing images again.</p>
<h3 id="active-server">Active server<a class="headerlink" href="#active-server" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://chef.libremesh.org">chef.libremesh.org</a></li>
</ul>
<h2 id="run-your-own-server">Run your own server<a class="headerlink" href="#run-your-own-server" title="Permanent link">&para;</a></h2>
<p>Redis is required to store image requests:</p>
<pre class="codehilite"><code>sudo apt install redis-server tar</code></pre>


<p>Install <em>asu</em>:</p>
<pre class="codehilite"><code>pip install asu</code></pre>


<p>Start the server via the following commands:</p>
<pre class="codehilite"><code>export FLASK_APP=asu  # set Flask app to asu
flask janitor init    # download upstream profiles/packages
flask run             # run development server</code></pre>


<p>Start the worker via the following comand:</p>
<pre class="codehilite"><code>rq worker</code></pre>


<h3 id="production">Production<a class="headerlink" href="#production" title="Permanent link">&para;</a></h3>
<p>It is recommended to run <em>ASU</em> via <code>gunicorn</code> proxied by <code>nginx</code>. Find a
possible <code>nginx</code> configuration in the <code>misc/</code> folder. Also the setup should not
HTTPS to allow clients without SSL/certificates to check for upgrades.</p>
<p>To change the default setting place a file called <code>config.py</code> in the root of
the <a href="https://flask.palletsprojects.com/en/1.1.x/config/#instance-folders">instance
folder</a>.
Find an example in the <code>misc/</code> folder.</p>
<pre class="codehilite"><code>pip install gunicorn
gunicorn &quot;asu:create_app()&quot;</code></pre>


<h3 id="development">Development<a class="headerlink" href="#development" title="Permanent link">&para;</a></h3>
<p>After cloning this repository create a Python virtual environment and install
the dependencies:</p>
<pre class="codehilite"><code>python3 -m venv .
source bin/activate
pip install -r requirements.txt
export FLASK_APP=asu  # set Flask app to asu
export FLASK_DEBUG=1  # run Flask in debug mode (autoreload)
flask run</code></pre>


<h2 id="api">API<a class="headerlink" href="#api" title="Permanent link">&para;</a></h2>
<h3 id="upgrade-check-apiversions">Upgrade check <code>/api/versions</code><a class="headerlink" href="#upgrade-check-apiversions" title="Permanent link">&para;</a></h3>
<p>The server does no longer offer complex upgrade but only serves static JSON
files including available versions. For now the client must evaluate if the
responded JSON contains a newer version.</p>
<h3 id="build-request-apibuild">Build request <code>/api/build</code><a class="headerlink" href="#build-request-apibuild" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
<th>information</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>version</code></td>
<td><code>SNAPSHOT</code></td>
<td>installed version</td>
</tr>
<tr>
<td><code>profile</code></td>
<td><code>netgear_wndr4300-v2</code></td>
<td><code>board_name</code> of <code>ubus call system board</code></td>
</tr>
<tr>
<td><code>packages</code></td>
<td><code>["luci", "vim"]</code></td>
<td>Extra packages for the new image</td>
</tr>
</tbody>
</table>
<p>Each valid request returns a <code>request_hash</code> which can be used for future
polling via <code>/api/build/&lt;request_hash&gt;</code>.</p>
<h3 id="response-status-200">Response <code>status 200</code><a class="headerlink" href="#response-status-200" title="Permanent link">&para;</a></h3>
<p>A <code>200</code> response means the image was sucessfully created. The response is JSON
encoded containing build information.</p>
<table>
<thead>
<tr>
<th>key</th>
<th>information</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bin_dir</code></td>
<td>relative path to created files</td>
</tr>
<tr>
<td><code>buildlog</code></td>
<td>boolean if buildlog.txt was created</td>
</tr>
<tr>
<td><code>manifest</code></td>
<td>dict of all installed packages plus version</td>
</tr>
<tr>
<td><code>request_hash</code></td>
<td>hashed request data stored by the server</td>
</tr>
</tbody>
</table>
<pre class="codehilite"><code>{
  &quot;build_at&quot;: &quot;Tue, 25 Feb 2020 08:49:48 GMT&quot;,
  &quot;enqueued_at&quot;: &quot;Tue, 25 Feb 2020 08:49:09 GMT&quot;,
  &quot;id&quot;: &quot;avm_fritzbox-4040&quot;,
  &quot;image_prefix&quot;: &quot;openwrt-387e9d003d04-ipq40xx-generic-avm_fritzbox-4040&quot;,
  &quot;images&quot;: [
    {
      &quot;name&quot;: &quot;openwrt-387e9d003d04-ipq40xx-generic-avm_fritzbox-4040-squashfs-eva.bin&quot;,
      &quot;sha256&quot;: &quot;8cb0d58bf672ed442f0813a1f04ec2f5edf6e2b64c8f117cb11158e19251aa0b&quot;,
      &quot;type&quot;: &quot;eva&quot;
    },
    {
      &quot;name&quot;: &quot;openwrt-387e9d003d04-ipq40xx-generic-avm_fritzbox-4040-squashfs-sysupgrade.bin&quot;,
      &quot;sha256&quot;: &quot;0d12ce60dd63422a63ed28f0e2a2ab2d367a407ccc32b665c28c809f3cb073f1&quot;,
      &quot;type&quot;: &quot;sysupgrade&quot;
    }
  ],
  &quot;manifest&quot;: {
    &quot;ath10k-firmware-qca4019-ct&quot;: &quot;2019-10-03-d622d160-1&quot;,
    &quot;base-files&quot;: &quot;213-r12297-7e9c7e7b2d&quot;,
    &quot;busybox&quot;: &quot;1.31.1-1&quot;,
    &quot;cgi-io&quot;: &quot;17&quot;,
    &quot;dnsmasq&quot;: &quot;2.80-18&quot;,
    [...]
    &quot;uclient-fetch&quot;: &quot;2020-01-05-fef6d3d3-1&quot;,
    &quot;uhttpd&quot;: &quot;2020-02-12-2ee323c0-1&quot;,
    &quot;urandom-seed&quot;: &quot;1.0-1&quot;,
    &quot;urngd&quot;: &quot;2020-01-21-c7f7b6b6-1&quot;,
    &quot;usign&quot;: &quot;2019-09-21-f34a383e-1&quot;,
    &quot;vim&quot;: &quot;8.1-6&quot;,
    &quot;wireless-regdb&quot;: &quot;2019.06.03&quot;,
    &quot;wpad-basic&quot;: &quot;2019-08-08-ca8c2bd2-6&quot;,
    &quot;zlib&quot;: &quot;1.2.11-3&quot;
  },
  &quot;metadata_version&quot;: 1,
  &quot;request_hash&quot;: &quot;5bac6cb8321f&quot;,
  &quot;supported_devices&quot;: [
    &quot;avm,fritzbox-4040&quot;
  ],
  &quot;target&quot;: &quot;ipq40xx/generic&quot;,
  &quot;titles&quot;: [
    {
      &quot;model&quot;: &quot;FRITZ!Box 4040&quot;,
      &quot;vendor&quot;: &quot;AVM&quot;
    }
  ],
  &quot;version_commit&quot;: &quot;r12297-7e9c7e7b2d&quot;,
  &quot;version_number&quot;: &quot;SNAPSHOT&quot;
}</code></pre>


<h3 id="response-status-codes">Response status codes<a class="headerlink" href="#response-status-codes" title="Permanent link">&para;</a></h3>
<p>The client should check the status code:</p>
<table>
<thead>
<tr>
<th>status</th>
<th>meaning</th>
<th>information</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>200</code></td>
<td>build finish / upgrade available</td>
<td>see parameters above</td>
</tr>
<tr>
<td><code>202</code></td>
<td>building, queued, imagebuilder setup</td>
<td>building right now or in build queue</td>
</tr>
<tr>
<td><code>400</code></td>
<td>bad request</td>
<td>see <code>error</code> parameter</td>
</tr>
<tr>
<td><code>404</code></td>
<td>not found</td>
<td>if invalid <code>request_hash</code> supplied via <code>/api/build/&lt;request_hash&gt;</code></td>
</tr>
<tr>
<td><code>422</code></td>
<td>unknown package</td>
<td>unknown package in request</td>
</tr>
<tr>
<td><code>500</code></td>
<td>build failed</td>
<td>see <code>log</code> for build log</td>
</tr>
</tbody>
</table></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js" defer></script>
        <script src="search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2020-03-01 00:32:51
-->
